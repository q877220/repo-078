# ðŸš€ é™æ€å¯¼èˆªç«™è‡ªåŠ¨éƒ¨ç½²å·¥ä½œæµ
name: Deploy Static Navigation Site

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ðŸ” ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    runs-on: ubuntu-latest
    name: ðŸ” Code Quality Check
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ðŸ“‹ Install dependencies
        run: |
          npm ci --only=dev || npm install --only=dev

      - name: ðŸ” Lint HTML
        run: |
          npx htmlhint *.html || echo "HTML lint completed"

      - name: ðŸŽ¨ Lint CSS
        run: |
          npx stylelint "styles/**/*.css" || echo "CSS lint completed"

      - name: âš¡ Lint JavaScript
        run: |
          npx eslint "scripts/**/*.js" || echo "JS lint completed"

  # ðŸ§ª åŠŸèƒ½æµ‹è¯•
  test:
    runs-on: ubuntu-latest
    name: ðŸ§ª Functionality Test
    needs: lint
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸŒ Start local server
        run: |
          npx http-server . -p 8080 &
          sleep 5

      - name: ðŸ” Test site accessibility
        run: |
          curl -f http://localhost:8080/ || exit 1
          curl -f http://localhost:8080/styles/main.css || exit 1
          curl -f http://localhost:8080/scripts/main.js || exit 1
          echo "âœ… All files accessible"

      - name: ðŸ“Š Performance audit
        run: |
          npm install -g lighthouse
          lighthouse http://localhost:8080/ --output json --output-path ./lighthouse-report.json --chrome-flags="--headless --no-sandbox" || echo "Lighthouse completed"

      - name: ðŸ“‹ Upload lighthouse report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lighthouse-report
          path: lighthouse-report.json

  # ðŸš€ éƒ¨ç½²åˆ°GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    name: ðŸš€ Deploy to GitHub Pages
    needs: [lint, test]
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¦ Optimize assets
        run: |
          # åŽ‹ç¼©CSS (ç§»é™¤æ³¨é‡Šå’Œç©ºç™½)
          if command -v csso &> /dev/null; then
            echo "ðŸŽ¨ Optimizing CSS..."
            csso styles/main.css --output styles/main.min.css
            mv styles/main.min.css styles/main.css
          fi
          
          # åŽ‹ç¼©JavaScript (ç§»é™¤æ³¨é‡Šå’Œç©ºç™½)
          if command -v terser &> /dev/null; then
            echo "âš¡ Optimizing JavaScript..."
            terser scripts/main.js --compress --mangle --output scripts/main.min.js
            mv scripts/main.min.js scripts/main.js
          fi
          
          echo "âœ… Asset optimization completed"

      - name: ðŸ“„ Generate sitemap
        run: |
          cat > sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://q877220.github.io/repo-078/</loc>
              <lastmod>$(date +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
          </urlset>
          EOF

      - name: ðŸ¤– Generate robots.txt
        run: |
          cat > robots.txt << 'EOF'
          User-agent: *
          Allow: /
          
          Sitemap: https://q877220.github.io/repo-078/sitemap.xml
          EOF

      - name: ðŸ“Š Generate deployment info
        run: |
          cat > deployment-info.json << EOF
          {
            "deployedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "workflow": "${{ github.run_id }}",
            "version": "1.0.0"
          }
          EOF

      - name: ðŸ“‹ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ðŸ“Š éƒ¨ç½²åŽéªŒè¯
  verify:
    runs-on: ubuntu-latest
    name: ðŸ“Š Post-deployment Verification
    needs: deploy
    if: always()
    steps:
      - name: ðŸ” Verify deployment
        run: |
          echo "ðŸŒ Verifying site at: https://q877220.github.io/repo-078/"
          
          # ç­‰å¾…å‡ ç§’è®©éƒ¨ç½²ç”Ÿæ•ˆ
          sleep 30
          
          # éªŒè¯ä¸»é¡µ
          response=$(curl -s -o /dev/null -w "%{http_code}" https://q877220.github.io/repo-078/)
          if [ "$response" = "200" ]; then
            echo "âœ… Main page is accessible"
          else
            echo "âŒ Main page returned status: $response"
          fi
          
          # éªŒè¯CSSæ–‡ä»¶
          response=$(curl -s -o /dev/null -w "%{http_code}" https://q877220.github.io/repo-078/styles/main.css)
          if [ "$response" = "200" ]; then
            echo "âœ… CSS file is accessible"
          else
            echo "âŒ CSS file returned status: $response"
          fi
          
          # éªŒè¯JSæ–‡ä»¶
          response=$(curl -s -o /dev/null -w "%{http_code}" https://q877220.github.io/repo-078/scripts/main.js)
          if [ "$response" = "200" ]; then
            echo "âœ… JavaScript file is accessible"
          else
            echo "âŒ JavaScript file returned status: $response"
          fi

      - name: ðŸŽ‰ Deployment Success Notification
        run: |
          echo "ðŸŽ‰ é™æ€å¯¼èˆªç«™éƒ¨ç½²æˆåŠŸ!"
          echo "ðŸŒ è®¿é—®åœ°å€: https://q877220.github.io/repo-078/"
          echo "ðŸ“Š æž„å»ºæ—¶é—´: $(date)"
          echo "ðŸ”— GitHubä»“åº“: https://github.com/q877220/repo-078"
